<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
x:Class="AcademiaDoZe.Presentation.AppMaui.Views.MatriculaPage"
xmlns:vm="clr-namespace:AcademiaDoZe.Presentation.AppMaui.ViewModels"
xmlns:enums="clr-namespace:AcademiaDoZe.Application.Enums;assembly=AcademiaDoZe.Application"
xmlns:converters="clr-namespace:AcademiaDoZe.Presentation.AppMaui.Converters"
x:DataType="vm:MatriculaViewModel"
Title="{Binding Title}">
    <ContentPage.Resources>
        <converters:FotoToImageSourceConverter x:Key="FotoToImageSourceConverter" />
        <converters:DateOnlyToDateTimeConverter x:Key="DateOnlyConverter" />
        <converters:EnumDisplayConverter x:Key="EnumDisplay" />
    </ContentPage.Resources>
    <ScrollView>
        <StackLayout Spacing="20">
            <!-- Dados Pessoais -->

            <Border Style="{StaticResource CardBorder}" Margin="15,10">

                <StackLayout Spacing="15">
                    <Label Text="{Binding Matricula.Id, StringFormat='Matricula ID: {0}'}" Style="{StaticResource SubHeadline}"/>
                    <StackLayout Spacing="5">
                        <Label Text="Objetivo"/>
                        <Entry Text="{Binding Matricula.Objetivo}" Placeholder="Digite o objetivo..."/>
                    </StackLayout>
                    <StackLayout Spacing="5">
                        <Label Text="Data de Inicio"/>
                        <DatePicker Date="{Binding Matricula.DataInicio, Converter={StaticResource DateOnlyConverter}, Mode=TwoWay}"/>
                    </StackLayout>
                    <StackLayout Spacing="5">
                        <Label Text="Data Final"/>
                        <DatePicker Date="{Binding Matricula.DataFim, Converter={StaticResource DateOnlyConverter}, Mode=TwoWay}"/>
                    </StackLayout>
                    <StackLayout Spacing="5">
                        <Label Text="Observações de Restrições"/>
                        <Entry Text="{Binding Matricula.ObservacoesRestricoes}" Placeholder="Digite as observações das restricções..."/>
                    </StackLayout>
                    <StackLayout Spacing="5">
                        <Label Text="Laudo Médico"/>
                        <Image Source="{Binding Matricula.LaudoMedico, Converter={StaticResource FotoToImageSourceConverter}}" Aspect="AspectFill" HeightRequest="120" WidthRequest="120"/>
                        <Button Text="Selecionar Imagem" Command="{Binding SelecionarFotoCommand}" Style="{StaticResource ButtonPrimary}" >
                            <Button.ImageSource>
                                <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe226;" />
                            </Button.ImageSource>
                        </Button>
                    </StackLayout>
                </StackLayout>
            </Border>
            <!-- AlunoMatricula -->

            <Border Style="{StaticResource CardBorder}" Margin="15,10">

                <StackLayout Spacing="15">
                    <Label Text="Aluno" Style="{StaticResource SubHeadline}"/>
                    <!-- Busca CPF -->

                    <Grid ColumnDefinitions="*,Auto">

                        <Entry Grid.Column="0" Text="{Binding Matricula.AlunoMatricula.Cpf}" Placeholder="000.000.000-00" Keyboard="Numeric" Margin="0,0,10,0"/>
                        <Button Grid.Column="1" Text="" Command="{Binding SearchByCpfCommand}" Style="{StaticResource ButtonPrimary}" HeightRequest="40" Padding="15,0">
                            <Button.ImageSource>
                                <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe8b6;" />
                            </Button.ImageSource>
                        </Button>
                    </Grid>

                    <!-- Card somente leitura -->
                    <Border Margin="0,10,0,0" Padding="10" BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource Gray900}}">

                        <StackLayout>
                            <Label Text="{Binding Matricula.AlunoMatricula.Foto, StringFormat='Foto: {0}'}"/>
                            <Label Text="{Binding Matricula.AlunoMatricula.Nome, StringFormat='Nome: {0}'}"/>
                            <Label Text="{Binding Matricula.AlunoMatricula.Cpf, StringFormat='CPF: {0}'}"/>
                            <Label Text="{Binding Matricula.AlunoMatricula.DataNascimento, StringFormat='Data de Nascimento: {0}'}"/>
                        </StackLayout>
                    </Border>
                </StackLayout>
            </Border>
            
            <Border Style="{StaticResource CardBorder}" Margin="15,10">

                <StackLayout Spacing="15">
                    <Label Text="Dados de Extras" Style="{StaticResource SubHeadline}"/>
                    <StackLayout Spacing="5">
                        <Label Text="Plano"/>
                        <Picker ItemsSource="{Binding MatriculaPlanos}" SelectedItem="{Binding Matricula.Plano}">
                            <Picker.ItemDisplayBinding>
                                <Binding Converter="{StaticResource EnumDisplay}" />
                            </Picker.ItemDisplayBinding>
                        </Picker>
                    </StackLayout>
                    <StackLayout Spacing="5">
                        <Label Text="Restrições Médicas"/>
                        <Picker ItemsSource="{Binding MatriculaRestricoesMedicas}" SelectedItem="{Binding Matricula.RestricoesMedicas}">
                            <Picker.ItemDisplayBinding>
                                <Binding Converter="{StaticResource EnumDisplay}" />
                            </Picker.ItemDisplayBinding>
                        </Picker>
                    </StackLayout>
                </StackLayout>
            </Border>
            <!-- Botões de Ação -->

            <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="15,10">

                <Button Grid.Column="0" Text="Cancelar" Command="{Binding CancelCommand}" Style="{StaticResource ButtonSecondary}" HeightRequest="50">
                    <Button.ImageSource>
                        <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe5c9;" />
                    </Button.ImageSource>
                </Button>

                <Button Grid.Column="1" Text="Salvar" Command="{Binding SaveMatriculaCommand}" Style="{StaticResource ButtonPrimary}" HeightRequest="50">

                    <Button.ImageSource>
                        <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe161;" />
                    </Button.ImageSource>
                </Button>
            </Grid>
            <!-- Loading Indicator -->
            <ActivityIndicator IsVisible="{Binding IsBusy}" IsRunning="{Binding IsBusy}" VerticalOptions="Center" HorizontalOptions="Center"/>

        </StackLayout>
    </ScrollView>
</ContentPage>